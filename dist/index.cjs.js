/*!
 * ws-mock v1.0.0 by Mr.Rainüåπ
 * (c) 2019-2019 
 * http://git.tianrang-inc.com:TR-FRONT/ws-mock.git
 * Released under the MIT License.
 */
"use strict";var procSentData=function(e){var t=0,n=e;return"string"==typeof e?t+=e.length:e instanceof ArrayBuffer?t+=e.byteLength:e instanceof Blob?t+=e.size:e.byteLength?t+=e.byteLength*(e.BYTES_PER_ELEMENT||1):t+=(n=""+e).length,{dataToBeSent:n,dataSize:t}},isValidUrl=function(e){if("function"!=typeof URL)return"string"==typeof e&&""!==e;var t={};try{t=new URL(e)}catch(t){return"The URL '"+e+"' is invalid."}var n=t.protocol;return"ws:"===n||"wss:"===n||"The URL's scheme must be either 'ws' or 'wss'. '"+n.slice(0,-1)+"' is not allowed."},isUrlMatched=function(e,t){if(typeof e==typeof t&&"string"==typeof e)return e===t;if(e instanceof RegExp&&t instanceof RegExp)return e.toString()===t.toString();var n="",o=e instanceof RegExp?(n=t,e):t instanceof RegExp?(n=e,t):void 0;return void 0!==o&&o.test(n)},getCurrent=function(){return~~((new Date).getTime()/1e3)},MyEventTarget=function(){function e(){this.listeners={}}return e.prototype.addEventListener=function(e,t){Reflect.has(this.listeners,e)||(this.listeners[e]=[]);var n=this.listeners[e];return n.push(t),n.length-1},e.prototype.removeEventListener=function(e,t){if(Reflect.has(this.listeners,e))for(var n=this.listeners[e],o=0,r=n.length;o<r;o++)if(n[o]===t)return void n.splice(o,1)},e.prototype.dispatchEvent=function(e){if(!Reflect.has(this.listeners,e.type))return!0;for(var t=this.listeners[e.type],n=0,o=t.length;n<o;n++)t[n].call(this,e);return!e.defaultPrevented},e.prototype.modifyHandler=function(e,t,n){Reflect.has(this.listeners,e)&&"number"==typeof t&&(this.listeners[e][t]=n)},e.prototype.removeAllListeners=function(){this.listeners={}},e}(),_eventBus=new MyEventTarget,extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function __extends(e,t){function n(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},mockSocketUrls=[],mockSocketSettings=[],storeMock=function(e){var t=-1;mockSocketUrls.some((function(n,o){return!!isUrlMatched(n[0],e.url)&&(t=o,!0)}))?mockSocketSettings[t].push(e):(mockSocketUrls.push([e.url]),mockSocketSettings.push([e]))},_WebSocket=window.WebSocket,onEvents=["close","error","message","open"],WebSocket=function(e){function t(n,o){var r=e.call(this)||this;if(r.onclose=null,r.onerror=null,r.onmessage=null,r.onopen=null,r._url="",r._index=-1,r._readyState=t.CONNECTING,r._bufferedAmount=0,arguments.length<1)throw TypeError("Failed to construct 'WebSocket': 1 argument required, but only 0 present.");for(var i=0;i<mockSocketUrls.length;i++)if(isUrlMatched(mockSocketUrls[i][0],n)){console.log("ÂºÄÂßãÈìæÊé•");var s=isValidUrl(n);if("string"==typeof s)throw new DOMException("Failed to construct 'WebSocket': "+s);return r._observeProps(),r._url=n,r._index=i,r._closeEventDict={code:1e3,reason:"Connection of mock WebSocket with url '"+r._url+"' is closed because you are so ugly.",wasClean:!0},r._attachEvents(),setTimeout((function(){r._readyState=t.OPEN,mockSocketSettings[r._index].map((function(e){_eventBus.dispatchEvent({type:"_open",url:e.url,_id:e._id})}))}),WsMock.configs.CONNECTING_TIME),r}return console.log("%cMock setting for url '"+n+"' not found, native WebSocket will be invoked.","color: red;"),new _WebSocket(n,o)}return __extends(t,e),t.prototype.send=function(e){if(arguments.length<1)throw new TypeError("Failed to execute 'send' on 'WebSocket': 1 argument required, but only 0 present.");if(this._readyState===t.CONNECTING)throw new DOMException("Failed to execute 'send' on 'WebSocket': Still in CONNECTING state.","InvalidStateError");if(this._readyState===t.OPEN){var n=procSentData(e),o=n.dataToBeSent,r=mockSocketSettings[this._index],i=this._bufferedAmount/WsMock.configs.SEND_RATE*1e3;setTimeout((function(){r.map((function(t){var n=t.receiver;n&&n.call(t,o),_eventBus.dispatchEvent({type:"_receive",url:t.url,_id:t._id,data:e})}))}),i)}else console.log("WebSocket is already in CLOSING or CLOSED state.")},t.prototype.close=function(e,n){var o=this;if(void 0===e&&(e=1e3),e=Number(e),1e3!==(e=isNaN(e)||e<0?0:e>65535?65535:e)&&(e<3e3||e>4999))throw new DOMException("Failed to execute 'close' on 'WebSocket': \n        The code must be either 1000, or between 3000 and 4999. "+e+" is neither.","InvalidAccessError");this._readyState=t.CLOSING,setTimeout((function(){o._closeEventDict.code=e,n&&(o._closeEventDict.reason=n),o._readyState=t.CLOSED,o.removeAllListeners(),mockSocketSettings[o._index].map((function(e){_eventBus.dispatchEvent({type:"_close",url:e.url,_id:e._id})}))}),WsMock.configs.CLOSING_TIME)},t.prototype._attachEvents=function(){_eventBus.addEventListener("_message",this._dispatchMessageEvent.bind(this))},t.prototype._dispatchMessageEvent=function(e){isUrlMatched(e.url,this._url)&&this.dispatchEvent(this._defineEventProps(new MessageEvent("message",__assign({data:null,origin:this._url,lastEventId:"",source:null,ports:[]},e.messageEventDict))))},t.prototype._observeProps=function(){this._observeBinaryType(),this._observeBufferedAmount(),this._observeExtensions(),this._observeProtocol(),this._observeOnEvents(),this._observeReadyState(),this._observeUrl()},t.prototype._observeBinaryType=function(){var e=["blob","arraybuffer"],t="blob";Object.defineProperty(this,"binaryType",{configurable:!0,enumerable:!0,get:function(){return t},set:function(n){e.indexOf(n)>-1?t=n:console.warn("The provided value '"+n+"' is not a valid enum value of type BinaryType.")}})},t.prototype._observeBufferedAmount=function(){this._observeReadOnlyProps("bufferedAmount",0)},t.prototype._observeExtensions=function(){this._observeReadOnlyProps("extensions","")},t.prototype._observeProtocol=function(){this._observeReadOnlyProps("protocol","")},t.prototype._observeOnEvents=function(){var e=this;onEvents.map((function(t){var n,o=null;Object.defineProperty(e,"on"+t,{configurable:!0,enumerable:!0,get:function(){return o},set:function(e){o?this.modifyHandler(t,n,e):n=this.addEventListener(t,e),o=e}})}))},t.prototype._observeReadyState=function(){var e=this;this._observeReadOnlyProps("readyState",t.CONNECTING,(function(n){switch(n){case t.OPEN:e.dispatchEvent(e._defineEventProps(new Event("open")));break;case t.CLOSED:e.dispatchEvent(e._defineEventProps(new CloseEvent("close",e._closeEventDict)))}}))},t.prototype._observeUrl=function(){this._observeReadOnlyProps("url","")},t.prototype._observeReadOnlyProps=function(e,t,n){var o=t;Object.defineProperty(this,"_"+e,{configurable:!0,enumerable:!1,get:function(){return o},set:function(t){o=t,n&&"function"==typeof n&&n.call(this,t),Object.defineProperty(this,e,{value:o,configurable:!0,enumerable:!0,writable:!1})}}),this["_"+e]=t},t.prototype._defineEventProps=function(e){var t=this;return["srcElement","currentTarget","target"].map((function(n){Object.defineProperty(e,n,{value:t,configurable:!0,enumerable:!0})})),e},t.CONNECTING=0,t.OPEN=1,t.CLOSING=2,t.CLOSED=3,t}(MyEventTarget);WebSocket.prototype.CONNECTING=WebSocket.CONNECTING,WebSocket.prototype.OPEN=WebSocket.OPEN,WebSocket.prototype.CLOSING=WebSocket.CLOSING,WebSocket.prototype.CLOSED=WebSocket.CLOSED,WebSocket._nativeWebSocket=_WebSocket;var _id=0,WsMock=function(){function e(e){var t=this;this.timeLineTask={},this.IWSTaskList=[],this.sendTypeMap={},this.unRegisterTypeMap={},this.start=function(){var e=t.setting,n=e.url,o=e._id;_eventBus.addEventListener("_receive",(function(e){isUrlMatched(e.url,n)&&e._id===o&&t.receiver(e.data)})),_eventBus.addEventListener("_open",(function(e){isUrlMatched(e.url,n)&&e._id===o&&(t.execute(),console.log(t.setting.url,"mockÂ∑≤ÂºÄÂêØ"))})),_eventBus.addEventListener("_close",(function(e){isUrlMatched(e.url,n)&&e._id===o&&(t.close(),console.log(n,"mockÂ∑≤ÂÖ≥Èó≠"))}))},this.addTask=function(e){var n=e.sendType,o=e.unRegisterType;e.isExpire=!0,t.IWSTaskList.push(e);var r=t.IWSTaskList.length-1;t.sendTypeMap[n]=r,o&&(t.unRegisterTypeMap[o]=r)},this.close=function(){t.timeLineTask=[],t.IWSTaskList.forEach((function(e){e.isExpire=!0})),clearInterval(t.timer)},this.sendMsg=function(e,n){var o=procSentData(JSON.stringify({type:e,timestamp:new Date,data:n}));_eventBus.dispatchEvent({type:"_message",url:t.url,messageEventDict:{data:o.dataToBeSent}})},this.addTimeLineTask=function(e,n){if(void 0===n&&(n=0),0!==n&&-1!==n){var o=getCurrent()+n;t.timeLineTask[o]||(t.timeLineTask[o]=[]),t.timeLineTask[o].push(e)}},this._sender=function(e,t){return JSON.stringify({type:t.messageType,timestamp:new Date,data:e})},this._receiver=function(e){var n=JSON.parse(e),o=n.type,r=n.data,i=t.sendTypeMap[o],s=t.unRegisterTypeMap[o];if(void 0!==i){var a=t.IWSTaskList[i];return a.sendData=a.registerFunc?a.registerFunc(a.sendData,r):r,void(a.isExpire&&(a.isExpire=!1,t.addTimeLineTask(a,1)))}if(void 0!==s){void 0===r&&t.removeTask(s);var c=t.IWSTaskList[s];c.sendData=c.unRegisterFunc?c.unRegisterFunc(c.sendData,r):r,c.isExpire=!0}},this.execute=function(){t.timer=window.setInterval((function(){var e=getCurrent();t.timeLineTask[e]&&(t.timeLineTask[e].forEach((function(e){if(!e.isExpire){e.mockFunc((function(n){var o=procSentData(t.sender(n,e));_eventBus.dispatchEvent({type:"_message",url:t.url,messageEventDict:{data:o.dataToBeSent}})}),e.sendData),t.addTimeLineTask(e,e.time)}})),Reflect.deleteProperty(t.timeLineTask,e))}),1e3)},this.removeTask=function(e){t.IWSTaskList[e].isExpire=!0},e.url?(this.setting=e,this.url=e.url,this.sender=e.sender||this._sender,this.receiver=e.receiver||this._receiver,e._id=_id++,storeMock(e)):console.log("Url must be specified.")}return e.config=function(t){Object.assign(e.config,t)},e.configs={CONNECTING_TIME:100,CLOSING_TIME:100,SEND_RATE:1048576},e}();if(!Reflect.has(window,"WebSocket"))throw new Error("Your browser does not support WebSocket.");window.WebSocket=WebSocket,module.exports=WsMock;
//# sourceMappingURL=index.cjs.js.map
